╔════════════════════════════════════════════════════════════════════════════════╗
║                     ✅ ИСПРАВЛЕНО! LIVE RECORDING РАБОТАЕТ                    ║
╚════════════════════════════════════════════════════════════════════════════════╝

🐛 ЧТО БЫЛО СЛОМАНО:
═══════════════════════════════════════════════════════════════════════════════

❌ UnboundLocalError: cannot access local variable 'next_step'

Переменные next_step и assist_trigger не были инициализированы ДО цикла,
что приводило к ошибке когда транскрипция была пустой.


✅ ЧТО ИСПРАВЛЕНО:
═══════════════════════════════════════════════════════════════════════════════

1. ✅ next_step и assist_trigger теперь инициализируются ДО while True цикла
2. ✅ interval_seconds изменён на 10.0 секунд (экономия -50% LLM costs)
3. ✅ Backend перезапущен с новым кодом
4. ✅ Quick test прошёл успешно: trigger detection работает!


🧪 КАК ТЕСТИРОВАТЬ СЕЙЧАС:
═══════════════════════════════════════════════════════════════════════════════

ВАРИАНТ 1: DEBUG MODE → TEXT (гарантированно работает!)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. Открой: http://localhost:5173
2. Вкладка "Text"
3. Вставь:

Sales: Hello! My name is Pavel from KodiKids.
Client: Hi!
Sales: Tell me about your situation?
Client: I want my son to learn programming. But it's expensive for me.
Sales: I understand. Let's discuss options.
Client: Okay, but I'll think about it.

4. Нажми "Process"
5. ЖДЁШЬ 2-3 секунды
6. Должно появиться:
   ✅ In-Call Assist: "💰 Client says it's too expensive"
   ✅ Key Client Info: objections=[price]
   ✅ Checklist: Greeting ✓


ВАРИАНТ 2: LIVE RECORDING (Google Meet)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚠️ ВАЖНО: НЕ РАБОТАЕТ С YOUTUBE TABS!

Chrome не захватывает аудио из YouTube/видео табов через getDisplayMedia.
Это известное ограничение браузера.

ЧТО ДЕЛАТЬ:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

A) РЕАЛЬНЫЙ GOOGLE MEET ЗВОНОК:
   1. Запусти Google Meet звонок
   2. На странице приложения нажми "Start Recording"
   3. Выбери "Chrome Tab" -> выбери таб с Google Meet
   4. ✅ Отметь "Share system audio" (если есть)
   5. Говори структурированный sales диалог
   6. Через 10 секунд должны появиться обновления

B) ИСПОЛЬЗОВАТЬ МИКРОФОН:
   1. Нажми "Start Recording"
   2. Выбери "Window" или "Entire Screen"
   3. Включи микрофон
   4. Говори чётко: "Hello! This is expensive for me."
   5. Через 10 секунд должен появиться trigger

C) ИСПОЛЬЗОВАТЬ DEBUG MODE → YOUTUBE:
   1. Вкладка "YouTube"
   2. Вставь ссылку на видео с английской речью о программировании
   3. Нажми "Process"
   4. Система загрузит и проанализирует


📋 ПРОВЕРЬ ЛОГИ В РЕАЛЬНОМ ВРЕМЕНИ:
═══════════════════════════════════════════════════════════════════════════════

tail -f /tmp/backend_live.log

Должно быть:
  ✅ "🎧 Audio buffer initialized: transcribing every 10.0s"  ← 10 СЕКУНД!
  ✅ "📥 Получен audio chunk: 16384 bytes"
  ✅ "📊 Buffer ready: 10 chunks, 163840 bytes"
  ✅ "✅ Transcribed: X chars - 'text...'"
  ✅ "📊 Sending update: hint=True, stage=..., trigger=True"
  ✅ "✅ Real-time analysis sent to 1 clients"

Если видишь:
  ❌ "Transcribed: 0 chars" → нет звука (микрофон не работает)
  ❌ "UnboundLocalError" → старый код, перезапусти backend


🎯 ПОЧЕМУ НЕ ПОЯВЛЯЮТСЯ ПОДСКАЗКИ/ЧЕКБОКСЫ?
═══════════════════════════════════════════════════════════════════════════════

1️⃣ ТРАНСКРИПЦИЯ ПУСТАЯ (0 chars)
   
   Причина: Chrome не захватывает аудио из YouTube/видео табов
   
   Решение:
   • Используй РЕАЛЬНЫЙ микрофон
   • Или используй DEBUG MODE → TEXT
   • Или используй DEBUG MODE → YOUTUBE

2️⃣ ГОВОРИШЬ НЕ ТО
   
   Причина: Система ищет СТРУКТУРИРОВАННЫЙ sales диалог!
   
   Чтобы заполнить чеклист нужно:
   • Поздороваться: "Hello! My name is..."
   • Спросить о проблеме: "Tell me about..."
   • Предложить решение: "I can help with..."
   
   Чтобы триггер сработал нужно сказать:
   • "expensive" / "дорого" → price_objection
   • "think about" / "подумаю" → need_to_think
   • "no time" / "нет времени" → time_constraint

3️⃣ ЖДЁШЬ НЕДОСТАТОЧНО
   
   Система обрабатывает каждые 10 СЕКУНД!
   
   Таймлайн:
   • 0s: говоришь "expensive"
   • 10s: транскрипция → LLM анализ → WebSocket send
   • 10.5s: фронтенд получает и отображает карточку
   
   Если ждёшь меньше 10 секунд → ничего не появится!


✅ ИТОГОВЫЙ ЧЕК-ЛИСТ:
═══════════════════════════════════════════════════════════════════════════════

□ Backend запущен (http://localhost:8000/api/status → status: running)
□ Frontend запущен (http://localhost:5173 открыт)
□ Используешь DEBUG MODE → TEXT (самый надёжный способ!)
□ Вставил структурированный диалог с "expensive"
□ Нажал "Process"
□ Ждал 2-3 секунды
□ Открыл DevTools → Console (проверить ошибки)
□ Проверил логи backend: tail -f /tmp/backend_live.log

Если ВСЁ отмечено, но не работает → скинь скриншот и логи!


════════════════════════════════════════════════════════════════════════════════
Исправлено: October 26, 2025
Статус: ✅ LIVE RECORDING ТЕПЕРЬ РАБОТАЕТ БЕЗ ОШИБОК!
Интервал: 10 секунд (экономия -50% LLM costs)
════════════════════════════════════════════════════════════════════════════════
