# ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è analyze_client_sentiment()

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

```
–í—ã–∑–æ–≤–æ–≤ –∑–∞ 1.5 —á–∞—Å–∞: 1080
–ö–∞–∂–¥—ã–µ: 5 —Å–µ–∫
–°—Ç–æ–∏–º–æ—Å—Ç—å: $1.73
–í—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã: ~1,080,000 tokens
–í—ã—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã: ~216,000 tokens
```

---

## üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: –£–≤–µ–ª–∏—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–ë–´–°–¢–†–û, -50%)

### –ò–¥–µ—è
–í–º–µ—Å—Ç–æ –∞–Ω–∞–ª–∏–∑–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫ ‚Üí –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
# backend/utils/audio_buffer.py
interval_seconds = 5.0  # ‚Üê –ò–ó–ú–ï–ù–ò –ù–ê 10.0
```

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—Å—è:**
```
–ë—ã–ª–æ:    1080 –≤—ã–∑–æ–≤–æ–≤ –∑–∞ 90 –º–∏–Ω
–°—Ç–∞–Ω–µ—Ç:  540 –≤—ã–∑–æ–≤–æ–≤ –∑–∞ 90 –º–∏–Ω
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç

```
–°—Ç–æ–∏–º–æ—Å—Ç—å: $1.73 ‚Üí $0.86
–≠–∫–æ–Ω–æ–º–∏—è: -50% ($0.87 –∑–∞ –∑–≤–æ–Ω–æ–∫)

–í—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã:  1,080,000 ‚Üí 540,000
–í—ã—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã: 216,000 ‚Üí 108,000
```

### Trade-offs

```
‚úÖ –ü–ª—é—Å—ã:
  - –ü–æ–ª–æ–≤–∏–Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
  - –ü—Ä–æ—Å—Ç–æ –º–µ–Ω—è—Ç—å (–æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –∫–æ–¥–∞)
  - –í—Å—ë –µ—â—ë —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –±—ã—Å—Ç—Ä–æ (10 —Å–µ–∫ –∑–∞–¥–µ—Ä–∂–∫–∞)

‚ùå –ú–∏–Ω—É—Å—ã:
  - –ú–µ–Ω—å—à–µ —Ç–æ—á–Ω–æ—Å—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —ç–º–æ—Ü–∏–π
  - –ú–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –±—ã—Å—Ç—Ä—ã–µ —Å–º–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
  - 10 —Å–µ–∫ –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
```

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
‚úÖ **–ü–†–ò–ú–ï–† –î–õ–Ø PRODUCTION** ‚Äî —Ö–æ—Ä–æ—à–∏–π –±–∞–ª–∞–Ω—Å

---

## üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: –ë–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞ (–°–†–ï–î–ù–Ø–Ø –°–õ–û–ñ–ù–û–°–¢–¨, -70%)

### –ò–¥–µ—è
–°–æ–±—Ä–∞—Ç—å N –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å 1 –≤—ã–∑–æ–≤ LLM –≤–º–µ—Å—Ç–æ N

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–¢–µ–∫—É—â–∏–π flow:**
```
–°–µ–∫ 0:  "Hi"           ‚Üí LLM –≤—ã–∑–æ–≤ 1
–°–µ–∫ 5:  "I like it"    ‚Üí LLM –≤—ã–∑–æ–≤ 2
–°–µ–∫ 10: "But expensive"‚Üí LLM –≤—ã–∑–æ–≤ 3
```

**–ù–æ–≤—ã–π flow:**
```
–°–µ–∫ 0-15:  –ù–∞–∫–æ–ø–∏—Ç—å 3 —Ñ—Ä–∞–∑—ã
–°–µ–∫ 15:    ["Hi", "I like it", "But expensive"] ‚Üí –õ–õ–ú –≤—ã–∑–æ–≤ 1

–†–µ–∑—É–ª—å—Ç–∞—Ç: 3 –≤—ã–∑–æ–≤–∞ ‚Üí 1 –≤—ã–∑–æ–≤
```

### –ö–æ–¥

```python
# backend/main.py

class BatchAnalyzer:
    def __init__(self, batch_size=3, timeout_sec=15):
        self.batch_size = batch_size
        self.timeout_sec = timeout_sec
        self.batch_buffer = []
        self.last_flush_time = time.time()
    
    async def add_and_analyze(self, client_text):
        """–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç, –∏ –µ—Å–ª–∏ –±–∞—Ç—á –≥–æ—Ç–æ–≤ - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å"""
        self.batch_buffer.append(client_text)
        
        # –£—Å–ª–æ–≤–∏–µ 1: –±–∞—Ç—á –ø–æ–ª–Ω—ã–π
        is_batch_full = len(self.batch_buffer) >= self.batch_size
        
        # –£—Å–ª–æ–≤–∏–µ 2: timeout –∏—Å—Ç—ë–∫
        time_elapsed = time.time() - self.last_flush_time
        is_timeout = time_elapsed >= self.timeout_sec
        
        if is_batch_full or is_timeout:
            return await self.flush_batch()
        
        return None  # –ñ–¥—ë–º –µ—â–µ
    
    async def flush_batch(self):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–∞—Ç—á –Ω–∞ –∞–Ω–∞–ª–∏–∑"""
        if not self.batch_buffer:
            return None
        
        combined_text = " ".join(self.batch_buffer)
        
        # –û–¥–∏–Ω –≤—ã–∑–æ–≤ LLM –≤–º–µ—Å—Ç–æ N
        result = await llm_analyzer.analyze_client_sentiment(
            combined_text,
            full_context
        )
        
        self.batch_buffer = []
        self.last_flush_time = time.time()
        
        return result
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```python
batch_analyzer = BatchAnalyzer(batch_size=3, timeout_sec=15)

# –í websocket_ingest —Ü–∏–∫–ª–µ
if transcript:
    result = await batch_analyzer.add_and_analyze(transcript)
    if result:
        # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ frontend —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–∞—Ç—á –≥–æ—Ç–æ–≤
        await broadcast_to_coach(result)
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç

```
–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: batch_size=3, timeout=15 —Å–µ–∫

–ó–∞ 90 –º–∏–Ω:
  –ë–µ–∑ –±–∞—Ç—á–∞:    1080 –≤—ã–∑–æ–≤–æ–≤ (–∫–∞–∂–¥—ã–µ 5 —Å–µ–∫)
  –° –±–∞—Ç—á–µ–º:     360 –≤—ã–∑–æ–≤–æ–≤ (–∫–∞–∂–¥—ã–µ 15 —Å–µ–∫) ‚Üê 3 —Ñ—Ä–∞–∑—ã —Å–æ–±—Ä–∞–Ω—ã
  
–≠–∫–æ–Ω–æ–º–∏—è: 1080 / 360 = 66% —ç–∫–æ–Ω–æ–º–∏—è

–°—Ç–æ–∏–º–æ—Å—Ç—å: $1.73 ‚Üí $0.59
–≠–∫–æ–Ω–æ–º–∏—è: -$1.14 –∑–∞ –∑–≤–æ–Ω–æ–∫
```

### Trade-offs

```
‚úÖ –ü–ª—é—Å—ã:
  - 66% —ç–∫–æ–Ω–æ–º–∏—è
  - –ë–æ–ª–µ–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–≤–∏–¥–∏—Ç 3 —Ñ—Ä–∞–∑—ã —Å—Ä–∞–∑—É)
  - –†–∞–±–æ—Ç–∞–µ—Ç –ª—É—á—à–µ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑

‚ùå –ú–∏–Ω—É—Å—ã:
  - –ó–∞–¥–µ—Ä–∂–∫–∞ 15 —Å–µ–∫ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (15 —Å–µ–∫ –∂–¥—ë—à—å –±–∞—Ç—á –ò–õ–ò timeout)
  - –°–ª–æ–∂–Ω–µ–µ –æ—Ç–ª–∞–¥–∏—Ç—å
  - UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ä–µ–∂–µ
```

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
‚ö†Ô∏è **–î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö/budget-–≤–µ—Ä—Å–∏–∏** ‚Äî –µ—Å–ª–∏ –¥–æ–ø—É—Å—Ç–∏–º–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ UI

---

## üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—è 3: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–ü–†–û–°–¢–ê–Ø, -30%)

### –ò–¥–µ—è
–ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞ LLM –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø–æ—Ö–æ–∂ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

```python
# backend/utils/llm_analyzer.py

class CachedLLMAnalyzer:
    def __init__(self):
        self.last_analysis = None
        self.last_text_hash = None
        self.cache_timeout = 60  # —Å–µ–∫
        self.last_cache_time = 0
    
    def _text_hash(self, text):
        """–ë—ã—Å—Ç—Ä—ã–π —Ö–µ—à —Ç–µ–∫—Å—Ç–∞"""
        import hashlib
        return hashlib.md5(text.encode()).hexdigest()
    
    def _text_similarity(self, text1, text2):
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ö–æ–∂–µ—Å—Ç—å —Ç–µ–∫—Å—Ç–æ–≤ (> 80% —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)"""
        # –ü—Ä–æ—Å—Ç–æ–π –º–µ—Ç–æ–¥: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–æ–≤–ø–∞–¥–∞—é—Ç –ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
        words1 = set(text1.lower().split())
        words2 = set(text2.lower().split())
        
        if not words1 or not words2:
            return 0.0
        
        intersection = len(words1 & words2)
        union = len(words1 | words2)
        
        return intersection / union if union > 0 else 0.0
    
    async def analyze_client_sentiment(self, client_text, context):
        """–ê–Ω–∞–ª–∏–∑ —Å –∫—ç—à–µ–º"""
        current_time = time.time()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –µ—Å—Ç—å –ª–∏ –∫—ç—à –∏ –Ω–µ —É—Å—Ç–∞—Ä–µ–ª –ª–∏?
        if (self.last_analysis and 
            current_time - self.last_cache_time < self.cache_timeout):
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ø–æ—Ö–æ–∂ –ª–∏ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π?
            similarity = self._text_similarity(
                client_text, 
                self.last_text  # ‚Üê —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            )
            
            if similarity > 0.8:  # 80% —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                print(f"‚úÖ Cache hit (similarity: {similarity:.0%})")
                return self.last_analysis  # –í–µ—Ä–Ω—É—Ç—å –∫—ç—à, NO LLM
        
        # –ö—ç—à –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç ‚Üí –≤—ã–∑–≤–∞—Ç—å LLM
        print(f"‚ùå Cache miss ‚Üí calling LLM")
        result = await self._call_llm_api(client_text, context)
        
        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à
        self.last_analysis = result
        self.last_text = client_text
        self.last_cache_time = current_time
        
        return result
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç

```
–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å cache hit (–ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ): ~30%

–ó–∞ 90 –º–∏–Ω:
  –ë—ã–ª–æ:    1080 –≤—ã–∑–æ–≤–æ–≤
  LLM —Ç–æ–ª—å–∫–æ –¥–ª—è: 1080 √ó 0.7 = 756 –≤—ã–∑–æ–≤–æ–≤
  Cache: 1080 √ó 0.3 = 324 –≤—ã–∑–æ–≤–æ–≤ (–ë–ï–°–ü–õ–ê–¢–ù–û)

–≠–∫–æ–Ω–æ–º–∏—è: 30% * $1.73 = $0.52

–°—Ç–æ–∏–º–æ—Å—Ç—å: $1.73 ‚Üí $1.21
–≠–∫–æ–Ω–æ–º–∏—è: -$0.52 –∑–∞ –∑–≤–æ–Ω–æ–∫
```

### Trade-offs

```
‚úÖ –ü–ª—é—Å—ã:
  - 30% —ç–∫–æ–Ω–æ–º–∏—è –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è—Ö
  - –ù–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π UI
  - –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
  - –ú–æ–∂–Ω–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏

‚ùå –ú–∏–Ω—É—Å—ã:
  - –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –≤—Å–µ–≥–¥–∞ –Ω–æ–≤—ã–π
  - –ú–æ–∂–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã
  - –ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –ø–æ—Ä–æ–≥ similarity (80%)
```

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
‚úÖ **STACK WITH OTHER STRATEGIES** ‚Äî –∫–æ–º–±–∏–Ω–∏—Ä—É–π —Å #1 –∏–ª–∏ #2

---

## üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—è 4: Incremental analysis (–í–´–°–û–ö–ê–Ø –°–õ–û–ñ–ù–û–°–¢–¨, -60%)

### –ò–¥–µ—è
–í–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∫–∞–∂–¥—ã–π —Ä–∞–∑ ‚Üí –æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–∏–≤—à–∏–µ—Å—è –ø–æ–ª—è

### –ü—Ä–∏–º–µ—Ä

```python
# –í—ã–∑–æ–≤ 1 (—Å–µ–∫ 0): "I'm hesitant"
# –†–µ–∑—É–ª—å—Ç–∞—Ç:
{
  "emotion": "hesitant",         ‚Üê NEW
  "objections": ["price"],       ‚Üê NEW
  "interests": [],               ‚Üê NEW
  ...
}

# –í—ã–∑–æ–≤ 2 (—Å–µ–∫ 5): "I'm hesitant but game-based learning sounds fun"
# –¢–µ–∫—Å—Ç —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–∏–ª—Å—è (+ "but game-based learning sounds fun")
# –í–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ ‚Üí –¢–û–õ–¨–ö–û –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—è:
{
  "interests": ["game-based learning"]  ‚Üê UPDATED (–∏–∑ –Ω–æ–≤–æ–π —á–∞—Å—Ç–∏)
  // –û—Å—Ç–∞–ª—å–Ω–æ–µ –∏–∑ –∫—ç—à–∞
}

–†–µ–∑—É–ª—å—Ç–∞—Ç: 2 –≤—ã–∑–æ–≤–∞ ‚Üí –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å 1 –≤—ã–∑–æ–≤ –∑–∞ 2 —Ü–∏–∫–ª–∞
```

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (—Å–ª–æ–∂–Ω–∞—è)

```python
class IncrementalAnalyzer:
    def __init__(self):
        self.cached_result = None
        self.last_text = ""
        self.analysis_counter = 0
        self.full_analysis_frequency = 3  # –∫–∞–∂–¥—ã–π 3-–π —Ä–∞–∑ –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑
    
    async def analyze_incrementally(self, client_text, context):
        """–ê–Ω–∞–ª–∏–∑ —Å –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏"""
        self.analysis_counter += 1
        
        # –ö–∞–∂–¥—ã–π 3-–π –≤—ã–∑–æ–≤ - –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑
        if self.analysis_counter % self.full_analysis_frequency == 0:
            print("üìä Full LLM analysis")
            self.cached_result = await self._full_analysis(client_text, context)
            self.last_text = client_text
            return self.cached_result
        
        # –û—Å—Ç–∞–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã - –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
        else:
            # –ù–∞–π—Ç–∏ —Ç–æ–ª—å–∫–æ –Ω–æ–≤—É—é —á–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞
            new_text = client_text[len(self.last_text):]
            
            if len(new_text.strip()) < 10:
                print(f"‚úÖ Incremental skip (too short)")
                return self.cached_result  # –í–µ—Ä–Ω—É—Ç—å –∫—ç—à, NO LLM
            
            print(f"üîÑ Incremental LLM analysis (only new: '{new_text[:30]}...')")
            
            # LLM –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤—É—é —á–∞—Å—Ç—å
            incremental_update = await self._incremental_analysis(
                new_text,
                self.cached_result,  # –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                context
            )
            
            # –ú–µ—Ä–∂–∏–º —Å—Ç–∞—Ä–æ–µ + –Ω–æ–≤–æ–µ
            self.cached_result = self._merge_results(
                self.cached_result,
                incremental_update
            )
            self.last_text = client_text
            
            return self.cached_result
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç

```
–ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–∞–∂–¥—ã–π 3-–π —Ä–∞–∑:

–ó–∞ 90 –º–∏–Ω:
  –ë—ã–ª–æ:    1080 –≤—ã–∑–æ–≤–æ–≤ –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
  –°—Ç–∞–Ω–µ—Ç:  1080 / 3 = 360 –ø–æ–ª–Ω—ã—Ö + 720 –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö
  LLM –≤—ã–∑–æ–≤–æ–≤: —Ç–æ–ª—å–∫–æ 360 (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏–∑ –∫—ç—à–∞ + –º–µ—Ä–∂)

–≠–∫–æ–Ω–æ–º–∏—è: 1080 - 360 = 720 –≤—ã–∑–æ–≤–æ–≤ = 66% —ç–∫–æ–Ω–æ–º–∏—è

–°—Ç–æ–∏–º–æ—Å—Ç—å: $1.73 ‚Üí $0.59
–≠–∫–æ–Ω–æ–º–∏—è: -$1.14 –∑–∞ –∑–≤–æ–Ω–æ–∫
```

### Trade-offs

```
‚úÖ –ü–ª—é—Å—ã:
  - 66% —ç–∫–æ–Ω–æ–º–∏—è
  - –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (UI –±—ã—Å—Ç—Ä–æ)
  - –•–æ—Ä–æ—à–∏–π –±–∞–ª–∞–Ω—Å

‚ùå –ú–∏–Ω—É—Å—ã:
  - –û–ß–ï–ù–¨ —Å–ª–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å
  - –ù—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å merge logic
  - –†–∏—Å–∫ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –ø–æ–ª–µ–π
  - –°–ª–æ–∂–Ω–æ –æ—Ç–ª–∞–¥–∏—Ç—å
```

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
‚ùå **–ù–ï –†–ï–ö–û–ú–ï–ù–î–£–Æ** ‚Äî —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–æ –¥–ª—è –≤—ã–∏–≥—Ä—ã—à–∞

---

## üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—è 5: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–µ—à–µ–≤—É—é –º–æ–¥–µ–ª—å (–ü–†–û–°–¢–û, -40%)

### –ò–¥–µ—è
Claude 3 Haiku ($0.80/$4) ‚Üí Claude 3 Sonnet ($3/$15)

**–ü–æ–≥–æ–¥–∏—Ç–µ, Sonnet –î–û–†–û–ñ–ï!** –ù–æ –µ—Å—Ç—å –º–∏–Ω–∏-–º–æ–¥–µ–ª–∏:
- **Claude 3.5 Haiku** (–Ω–æ–≤–∞—è): $0.80 input / $4 output ‚Äî **–ñ–ï –¢–ê –ñ–ï –¶–ï–ù–ê**
- **Llama 2 (–Ω–∞ OpenRouter)**: $0.0005 input / $0.0015 output ‚Äî **200x –¥–µ—à–µ–≤–ª–µ!**

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (–ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –º–æ–¥–µ–ª—å)

```python
# .env
LLM_MODEL=meta-llama/llama-2-70b-chat  # ‚Üê –≤–º–µ—Å—Ç–æ anthropic/claude-3-haiku

# –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å (–ë–ï–°–ü–õ–ê–¢–ù–û!)
LLM_MODEL=local  # ollama –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç (—Å Llama 2)

```
–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: $1.73 (Claude 3 Haiku)
–° Llama 2:    $0.01 (1080 √ó $0.0009 avg)

–≠–∫–æ–Ω–æ–º–∏—è: -99% ‚ùå –ù–ï–†–ï–ê–õ–¨–ù–û

–ù–æ Llama 2 –∫–∞—á–µ—Å—Ç–≤–æ —Ö—É–∂–µ ‚Üí –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫ –≤ –∞–Ω–∞–ª–∏–∑–µ
```

### Trade-offs

```
‚úÖ –ü–ª—é—Å—ã:
  - –†–µ–∑–∫–æ –¥–µ—à–µ–≤–ª–µ
  - –†–∞–±–æ—Ç–∞–µ—Ç offline (–µ—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–∞—è)

‚ùå –ú–∏–Ω—É—Å—ã:
  - –ö–∞—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–∏–∑–∞ —Å–∏–ª—å–Ω–æ —É–ø–∞–¥—ë—Ç
  - –ë–æ–ª—å—à–µ –æ—à–∏–±–æ–∫ –≤ detection (objections, interests)
  - –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –¥–ª—è production
```

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
‚ö†Ô∏è **–¢–æ–ª—å–∫–æ –¥–ª—è MVP/demo** ‚Äî –¥–ª—è production –∫–∞—á–µ—Å—Ç–≤–æ –≤–∞–∂–Ω–µ–µ

---

## üìä –°–†–ê–í–ù–ï–ù–ò–ï –í–°–ï–• –°–¢–†–ê–¢–ï–ì–ò–ô

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –°—Ç—Ä–∞—Ç–µ–≥–∏—è    ‚îÇ –≠–∫–æ–Ω–æ–º–∏—è ‚îÇ –°–ª–æ–∂–Ω–æ—Å—Ç—å ‚îÇ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ #1: +10 sec  ‚îÇ   -50%   ‚îÇ –û—á–µ–Ω—å     ‚îÇ ‚úÖ BEST for most    ‚îÇ
‚îÇ              ‚îÇ ($0.87)  ‚îÇ –ø—Ä–æ—Å—Ç–∞—è   ‚îÇ    cases            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ #2: Batch    ‚îÇ   -66%   ‚îÇ –°—Ä–µ–¥–Ω—è—è   ‚îÇ üü° Budget version   ‚îÇ
‚îÇ              ‚îÇ ($1.14)  ‚îÇ           ‚îÇ    (delay ok)       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ #3: Cache    ‚îÇ   -30%   ‚îÇ –ü—Ä–æ—Å—Ç–∞—è   ‚îÇ üü¢ Combine with #1  ‚îÇ
‚îÇ              ‚îÇ ($0.52)  ‚îÇ           ‚îÇ    or #2            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ #4: Incr.    ‚îÇ   -66%   ‚îÇ –°–ª–æ–∂–Ω–∞—è   ‚îÇ ‚ùå Too complex      ‚îÇ
‚îÇ              ‚îÇ ($1.14)  ‚îÇ           ‚îÇ                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ #5: Cheap    ‚îÇ   -99%   ‚îÇ –ü—Ä–æ—Å—Ç–∞—è   ‚îÇ ‚ùå Quality bad      ‚îÇ
‚îÇ              ‚îÇ ($1.72)  ‚îÇ           ‚îÇ                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï –ö–û–ú–ë–ò–ù–ê–¶–ò–ò

### Scenario A: –ú–∞–∫—Å–∏–º—É–º –∫–∞—á–µ—Å—Ç–≤–∞ (–¢–ï–ö–£–©–ò–ô)

```
–°—Ç—Ä–∞—Ç–µ–≥–∏—è: –ù–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è—Ç—å
–°—Ç–æ–∏–º–æ—Å—Ç—å: $1.73 –∑–∞ –∑–≤–æ–Ω–æ–∫
```

---

### Scenario B: –•–æ—Ä–æ—à–∏–π –±–∞–ª–∞–Ω—Å (–†–ï–ö–û–ú–ï–ù–î–£–Æ) üëà

```
–°—Ç—Ä–∞—Ç–µ–≥–∏–∏: #1 (10 sec) + #3 (cache)

–ö–æ–¥:
  interval_seconds = 10.0  # –≤–º–µ—Å—Ç–æ 5.0
  + enable caching logic
  
–†–µ–∑—É–ª—å—Ç–∞—Ç:
  Base: $1.73
  - 50% (#1): $0.87
  - 15% (#3): $0.13
  ‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï
  –ò–¢–û–ì–û: $1.73 - $1.00 = $0.73 –∑–∞ –∑–≤–æ–Ω–æ–∫
  
–≠–∫–æ–Ω–æ–º–∏—è: -58% ($1.00 –∑–∞ –∑–≤–æ–Ω–æ–∫)
–ó–∞ –º–µ—Å—è—Ü (1000 –∑–≤–æ–Ω–∫–æ–≤): $730 (–≤–º–µ—Å—Ç–æ $1730)
```

### –ö–æ–¥ –¥–ª—è Scenario B

```python
# backend/utils/audio_buffer.py
interval_seconds = 10.0  # –≤–º–µ—Å—Ç–æ 5.0
```

```python
# backend/utils/llm_analyzer.py
class LLMAnalyzer:
    def __init__(self):
        self.last_result = None
        self.last_text = ""
        self.cache_time = 0
        self.similarity_threshold = 0.80  # 80% —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    
    def _similarity(self, text1, text2):
        words1 = set(text1.lower().split())
        words2 = set(text2.lower().split())
        if not words1 or not words2:
            return 0.0
        intersection = len(words1 & words2)
        union = len(words1 | words2)
        return intersection / union if union > 0 else 0.0
    
    async def analyze_client_sentiment(self, client_text, context):
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—ç—à
        if (self.last_result and 
            time.time() - self.cache_time < 60 and
            self._similarity(client_text, self.last_text) > 0.80):
            print(f"‚úÖ Cache HIT")
            return self.last_result
        
        # LLM –≤—ã–∑–æ–≤
        result = await self._call_llm(client_text, context)
        
        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à
        self.last_result = result
        self.last_text = client_text
        self.cache_time = time.time()
        
        return result
```

---

### Scenario C: –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è (BUDGET)

```
–°—Ç—Ä–∞—Ç–µ–≥–∏–∏: #1 (10 sec) + #2 (batch size=4) + #3 (cache)

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
  interval_seconds = 10.0
  batch_size = 4
  timeout = 20 sec
  + caching

–†–µ–∑—É–ª—å—Ç–∞—Ç:
  Base: $1.73
  - 50% (#1): $0.87
  - 60% (#2): $1.04
  - 20% (#3): $0.35
  ‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï
  –ò–¢–û–ì–û: $1.73 - $2.26 = –Ω–µ–ª—å–∑—è (–º–∏–Ω—É—Å), –ø–æ–ø—Ä–æ–±—É–µ–º –∫–æ–º–±–æ:
  
  –†–µ–∞–ª—å–Ω–æ: 50% + 20% stack = -60%
  = $1.73 - $1.04 = $0.69 –∑–∞ –∑–≤–æ–Ω–æ–∫
  
–≠–∫–æ–Ω–æ–º–∏—è: -60% ($1.04 –∑–∞ –∑–≤–æ–Ω–æ–∫)
–ó–∞ –º–µ—Å—è—Ü: $690 (–æ—á–µ–Ω—å –¥—ë—à–µ–≤–æ)

UI –∑–∞–¥–µ—Ä–∂–∫–∞: 20 —Å–µ–∫ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–∞)
```

---

## üöÄ –ë–´–°–¢–†–û–ï –í–ù–ï–î–†–ï–ù–ò–ï (5 –ú–ò–ù)

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å —ç–∫–æ–Ω–æ–º–∏—Ç—å –°–ï–ô–ß–ê–°:

### –®–∞–≥ 1: –£–≤–µ–ª–∏—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª

```bash
# backend/utils/audio_buffer.py
# –°—Ç—Ä–æ–∫–∞ ~20-25, –Ω–∞–π–¥–∏:
interval_seconds = 5.0

# –ò–∑–º–µ–Ω–∏ –Ω–∞:
interval_seconds = 10.0
```

### –®–∞–≥ 2: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend

```bash
cd /Users/pavelloucker/SalesBestFriend/backend
pkill -f uvicorn
source venv/bin/activate
uvicorn main:app --reload --port 8000
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç

```
–≠–∫–æ–Ω–æ–º–∏—è: -50% ($0.87 –∑–∞ –∑–≤–æ–Ω–æ–∫)
–í—Ä–µ–º—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è: 2 –º–∏–Ω—É—Ç—ã
–ö–∞—á–µ—Å—Ç–≤–æ: –ü–æ—á—Ç–∏ –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è (–∑–∞–¥–µ—Ä–∂–∫–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ 5 —Å–µ–∫)
```

---

## üìà –î–û–õ–ì–û–°–†–û–ß–ù–ê–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø

### Q1: –¢–µ–∫—É—â–∏–π + –ö—ç—à

```
–°—Ç–æ–∏–º–æ—Å—Ç—å: $1.73 ‚Üí $1.21 (-30%)
–í—Ä–µ–º—è: 2-3 —á–∞—Å–∞
```

### Q2: + –£–≤–µ–ª–∏—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª

```
–°—Ç–æ–∏–º–æ—Å—Ç—å: $1.21 ‚Üí $0.73 (-58%)
–í—Ä–µ–º—è: 30 –º–∏–Ω—É—Ç
```

### Q3: + Incremental analysis (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```
–°—Ç–æ–∏–º–æ—Å—Ç—å: $0.73 ‚Üí $0.35 (-80%)
–í—Ä–µ–º—è: 4-5 —á–∞—Å–æ–≤
–†–∏—Å–∫: –≤—ã—Å–æ–∫–∏–π (–º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å—Å—è)
```

